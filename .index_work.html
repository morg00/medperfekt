<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    button { 
      padding: 15px 30px; 
      font-size: 18px; 
      background: #12c2b0; 
      color: white; 
      border: none; 
      border-radius: 12px; 
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: #0fa89c; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .debug { margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 8px; text-align: left; display: none; }
  </style>
</head>
<body>

  <h2>Тестовая заявка Medperfekt</h2>
  <p>Нажми кнопку — заявка улетит в админку</p>

  <button id="send">
    Отправить заявку
  </button>

  <div style="margin-top: 20px;">
    <label>
      <input type="checkbox" id="debugMode">
      Показать отладку
    </label>
  </div>

  <div id="debugInfo" class="debug"></div>

  <script>
    const tg = window.Telegram?.WebApp;
    const isInTelegram = tg && tg.initData;
    
    // Инициализация Telegram WebApp
    if (tg) {
      tg.ready();
      tg.expand();
    }

    // Отладочная информация
    function logDebug(message) {
      const debugDiv = document.getElementById('debugInfo');
      if (debugDiv) {
        debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
      }
      console.log(message);
    }

    // Показать/скрыть отладку
    document.getElementById('debugMode').onchange = function(e) {
      document.getElementById('debugInfo').style.display = e.target.checked ? 'block' : 'none';
    };

    document.getElementById("send").onclick = async () => {
      const button = document.getElementById("send");
      button.disabled = true;
      button.textContent = "Отправка...";
      
      logDebug("=== Начало отправки ===");

      try {
        // Собираем данные
        let userName = "Гость";
        let userId = 0;
        let queryId = "browser_" + Date.now();

        if (tg?.initDataUnsafe?.user) {
          const u = tg.initDataUnsafe.user;
          userName = [u.first_name, u.last_name].filter(Boolean).join(" ") || "Без имени";
          userId = u.id;
          if (tg.initDataUnsafe.query_id) {
            queryId = tg.initDataUnsafe.query_id;
          }
        }

        const data = {
          service: "Тест",
          request: "Тестовая заявка из Mini App",
          method: "Telegram",
          phone: "+79999999999",
          time: "any",
          language: "ru",
          user_name: userName,
          user_id: userId,
          source: isInTelegram ? "telegram" : "browser",
          timestamp: new Date().toISOString()
        };

        logDebug(`Режим: ${isInTelegram ? 'Telegram' : 'Браузер'}`);
        logDebug(`Данные: ${JSON.stringify(data, null, 2)}`);

        // 1. Если в Telegram - используем sendData
        if (tg?.sendData) {
          logDebug("Используем tg.sendData()");
          tg.sendData(JSON.stringify(data));
          
          tg.showAlert("Заявка отправлена через Telegram!", () => {
            setTimeout(() => tg.close(), 1000);
          });
          
          button.textContent = "Отправлено!";
          logDebug("Заявка отправлена через sendData");
          return;
        }

        // 2. Если в браузере - используем fetch с обходом CORS
        logDebug("Режим браузера, используем fetch API");
        
        // Вариант A: Прямой запрос (если сервер поддерживает CORS)
        let url = "https://medperfekt.duckdns.org/webapp-callback";
        
        // Вариант B: Через прокси для обхода CORS (раскомментируйте если вариант A не работает)
        // const proxyUrl = "https://corsproxy.io/?"; // Публичный CORS прокси
        // url = proxyUrl + encodeURIComponent(url);
        
        logDebug(`Отправляем на: ${url}`);

        const payload = {
          query_id: queryId,
          formData: data,
          user: tg?.initDataUnsafe?.user || { id: userId, first_name: userName },
          initData: tg?.initData,
          userAgent: navigator.userAgent
        };

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 сек таймаут

        try {
          const res = await fetch(url, {
            method: "POST",
            mode: 'cors', // или 'no-cors', но тогда не получим ответ
            headers: { 
              "Content-Type": "application/json",
              "Accept": "application/json"
            },
            body: JSON.stringify(payload),
            signal: controller.signal
          });

          clearTimeout(timeoutId);

          logDebug(`Статус ответа: ${res.status} ${res.statusText}`);

          if (res.ok) {
            const result = await res.json();
            logDebug(`Ответ сервера: ${JSON.stringify(result)}`);
            alert("✅ Заявка успешно отправлена!");
            button.textContent = "Успешно отправлено!";
            button.style.background = "#4CAF50";
          } else {
            const errorText = await res.text();
            logDebug(`Ошибка сервера: ${res.status} - ${errorText}`);
            throw new Error(`Сервер вернул ошибку ${res.status}`);
          }
        } catch (fetchError) {
          if (fetchError.name === 'AbortError') {
            throw new Error("Таймаут запроса (10 сек)");
          }
          throw fetchError;
        }

      } catch (error) {
        logDebug(`Ошибка: ${error.message}`);
        console.error("Полная ошибка:", error);
        
        // Показываем пользователю понятное сообщение
        let errorMessage = error.message;
        if (error.message.includes('CORS') || error.message.includes('NetworkError')) {
          errorMessage = "Проблема с соединением. Проверьте CORS настройки сервера.";
        } else if (error.message.includes('таймаут')) {
          errorMessage = "Сервер не отвечает. Попробуйте позже.";
        }
        
        alert(`❌ Ошибка отправки: ${errorMessage}\n\nДля разработчиков: проверьте консоль.`);
        
        button.disabled = false;
        button.textContent = "Попробовать снова";
      } finally {
        logDebug("=== Завершение отправки ===");
      }
    };

    // Добавляем глобальную функцию для тестирования
    window.testDirectRequest = async function() {
      console.log("Тестовый запрос напрямую...");
      const testData = {
        query_id: "test_" + Date.now(),
        formData: {
          service: "Тест из консоли",
          request: "Ручной тест",
          method: "Browser Console",
          phone: "+79998887766",
          time: "now",
          language: "ru",
          user_name: "Консольный тест",
          user_id: 999999
        },
        user: {
          id: 999999,
          first_name: "Консольный тест"
        }
      };
      
      try {
        const res = await fetch("https://medperfekt.duckdns.org/webapp-callback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(testData)
        });
        console.log("Результат:", await res.text());
      } catch (e) {
        console.error("Ошибка:", e);
      }
    };

    // Информация для отладки
    logDebug(`В Telegram: ${isInTelegram ? 'Да' : 'Нет'}`);
    logDebug(`User Agent: ${navigator.userAgent}`);
    logDebug(`TG WebApp доступен: ${!!tg}`);
    logDebug(`TG.sendData доступен: ${!!tg?.sendData}`);

  </script>
</body>
</html>