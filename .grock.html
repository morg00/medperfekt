<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="font-family: sans-serif; padding: 20px; text-align: center;">

  <h2>Тестовая заявка Medperfekt</h2>
  <p>Нажми кнопку — заявка улетит в админку</p>

  <button id="send" style="padding: 15px 30px; font-size: 18px; background: #12c2b0; color: white; border: none; border-radius: 12px; cursor: pointer;">
    Отправить заявку
  </button>

  <script>
        // Ждём Telegram WebApp
        // ВАЖНО: Правильное определение, находимся ли мы в Telegram
    const tg = window.Telegram?.WebApp;
    // Ключевой момент: проверяем наличие initData, а не просто объекта tg
    const isInRealTelegram = tg && tg.initData && tg.initDataUnsafe?.user;

    if (isInRealTelegram) {
        tg.ready();
        tg.expand();
    }

    document.getElementById("send").onclick = async () => {
        const button = document.getElementById("send");
        button.disabled = true;
        button.textContent = "Отправка...";

        try {
            // Собираем данные (ваш код)
            let userName = "Гость";
            let userId = 0;
            let queryId = "browser_" + Date.now();

            if (tg?.initDataUnsafe?.user) {
                const u = tg.initDataUnsafe.user;
                userName = [u.first_name, u.last_name].filter(Boolean).join(" ") || "Без имени";
                userId = u.id;
                if (tg.initDataUnsafe.query_id) {
                    queryId = tg.initDataUnsafe.query_id;
                }
            }

            const data = {
                service: "Тест",
                request: "Тестовая заявка из Mini App",
                method: "Telegram",
                phone: "+79999999999",
                time: "any",
                language: "ru",
                user_name: userName,
                user_id: userId,
                source: isInRealTelegram ? "telegram" : "browser",
                timestamp: new Date().toISOString()
            };

            // КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: Правильная проверка
            if (isInRealTelegram && tg.sendData) {
                console.log("Режим: Telegram, используем sendData");
                tg.sendData(JSON.stringify(data));
                
                // Используем showAlert только если уверены, что в Telegram
                tg.showAlert("Заявка отправлена!", () => {
                    setTimeout(() => tg.close(), 1000);
                });
                
                button.textContent = "Отправлено!";
                return;
            }

            // Режим браузера - используем fetch
            console.log("Режим: Браузер, используем fetch API");
            
            const payload = {
                query_id: queryId,
                formData: data,
                user: { id: userId, first_name: userName },
                userAgent: navigator.userAgent,
                origin: window.location.origin || 'null'
            };

            const response = await fetch("https://medperfekt.duckdns.org/webapp-callback", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                // В браузере используем обычный alert
                alert("✅ Заявка успешно отправлена!");
                button.textContent = "Успешно отправлено!";
                button.style.background = "#4CAF50";
            } else {
                throw new Error(`Ошибка сервера: ${response.status}`);
            }

        } catch (error) {
            console.error("Полная ошибка:", error);
            
            // Упрощенное сообщение об ошибке для пользователя
            alert(`❌ Ошибка отправки. Проверьте консоль для деталей.`);
            
            button.disabled = false;
            button.textContent = "Попробовать снова";
        }
    };
  </script>
</body>
</html> 