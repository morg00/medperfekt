<!doctype html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width,initial-scale=1,viewport-fit=cover"
        />
        <meta name="robots" content="noindex,nofollow" />
        <title>Medperfekt — Заявка</title>
        <script src="https://telegram.org/js/telegram-web-app.js"></script>
        <style>
            :root {
                /* палитра под сайт: белый + тёмный текст + бирюзовый акцент */
                --bg: #f6fbfc;
                --card: #ffffff;
                --ink: #0e2733;
                --muted: #6b7a86;
                --accent: #12c2b0; /* бирюзовый CTA */
                --accent-ghost: #e6faf7; /* мягкий фон акцента */
                --ring: #b8efe8;
                --radius: 18px;
                --shadow: 0 14px 40px rgba(10, 40, 50, 0.08);
                --speed: 0.32s;
            }
            * {
                box-sizing: border-box;
            }
            html,
            body {
                margin: 0;
                height: 100%;
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Inter,
                    Roboto,
                    Arial;
            }
            body {
                background: var(--bg);
                color: var(--ink);
            }
            .wrap {
                max-width: 760px;
                margin: 0 auto;
                padding: 20px 16px calc(24px + env(safe-area-inset-bottom));
            }
            .brand {
                display: flex;
                align-items: center;
                gap: 12px;
                margin: 2px 0 16px;
            }
            .logo {
                width: 44px;
                height: 44px;
                border-radius: 14px;
                background: #0bbfaa url("photo.jpg") center/cover no-repeat;
                box-shadow: 0 6px 18px rgba(11, 191, 170, 0.22);
            }
            .brand h2 {
                margin: 0;
                font-size: 18px;
                font-weight: 800;
                letter-spacing: 0.2px;
            }

            .card {
                background: var(--card);
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                border: 1px solid #edf3f5;
                padding: 18px;
            }
            h1 {
                font-size: 22px;
                margin: 2px 0 10px;
            }
            .muted {
                color: var(--muted);
                font-size: 14px;
            }
            .btn {
                height: 54px;
                border-radius: 16px;
                border: 0;
                background: var(--accent);
                color: #fff;
                font-weight: 700;
                cursor: pointer;
                padding: 0 20px;
            }
            .btn.ghost {
                background: var(--accent-ghost);
                color: #064e47;
                border: 1px solid #d2f4ee;
            }
            .btn.outline {
                background: #fff;
                border: 1px solid #e3edf0;
                color: var(--ink);
            }
            .grid {
                display: grid;
                gap: 12px;
            }
            .row {
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
            }
            .field {
                display: grid;
                gap: 6px;
            }
            label {
                font-size: 14px;
                color: var(--muted);
            }
            input,
            select,
            textarea {
                width: 100%;
                padding: 12px 14px;
                border: 1px solid #e3edf0;
                border-radius: 14px;
                background: #fff;
                font-size: 16px;
            }
            textarea {
                min-height: 96px;
                resize: vertical;
            }
            .chips {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }
            .chip {
                padding: 10px 14px;
                border-radius: 999px;
                border: 1px solid #e7f1f3;
                background: #fff;
                cursor: pointer;
            }
            .chip.sel {
                background: var(--accent-ghost);
                border-color: #c9efe8;
            }
            .sticky {
                position: sticky;
                bottom: 0;
                left: 0;
                right: 0;
                margin-top: 12px;
                background: linear-gradient(
                    180deg,
                    rgba(246, 251, 252, 0),
                    var(--bg) 40%
                );
                padding-top: 10px;
            }
            .cta {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }
            .ok {
                font-size: 56px;
                text-align: center;
            }

            /* шаги как всплывающие панели снизу */
            .sheet {
                position: fixed;
                left: 0;
                right: 0;
                bottom: -100%;
                background: var(--card);
                border-top-left-radius: 22px;
                border-top-right-radius: 22px;
                box-shadow: 0 -18px 60px rgba(0, 0, 0, 0.12);
                border: 1px solid #eaf2f4;
                max-width: 760px;
                margin: 0 auto;
                padding: 18px 16px;
                transition:
                    transform var(--speed) ease,
                    opacity var(--speed) ease;
                transform: translateY(100%);
                opacity: 0;
            }
            .sheet.show {
                transform: translateY(0);
                bottom: 0;
                opacity: 1;
            }
            .sheet .title {
                font-size: 18px;
                font-weight: 700;
                margin: 0 0 8px;
            }
            .sheet .subtitle {
                font-size: 14px;
                color: var(--muted);
                margin: 0 0 12px;
            }
            .overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.18);
                opacity: 0;
                pointer-events: none;
                transition: opacity var(--speed);
            }
            .overlay.show {
                opacity: 1;
                pointer-events: auto;
            }

            /* иконки способов связи */
            .method {
                display: flex;
                gap: 12px;
            }
            .method .opt {
                flex: 1;
                display: flex;
                align-items: center;
                gap: 10px;
                border: 1px solid #e3edf0;
                border-radius: 14px;
                padding: 12px;
                cursor: pointer;
                background: #fff;
            }
            .method .opt.sel {
                border-color: #b9efe7;
                background: var(--accent-ghost);
            }
            .method .icon {
                width: 28px;
                height: 28px;
                border-radius: 7px;
                display: block;
            }

            .hint {
                font-size: 12px;
                color: #7a8b96;
            }

            /* Стили для выбора услуг */
            .service-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .service-option {
                padding: 16px 12px;
                border: 1px solid #e3edf0;
                border-radius: 14px;
                background: #fff;
                cursor: pointer;
                text-align: center;
                font-size: 14px;
                font-weight: 500;
            }
            .service-option.sel {
                border-color: #b9efe7;
                background: var(--accent-ghost);
            }

            /* Стили для времени связи */
            .time-options {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 10px;
            }
            .time-option {
                padding: 12px 8px;
                border: 1px solid #e3edf0;
                border-radius: 12px;
                background: #fff;
                cursor: pointer;
                text-align: center;
                font-size: 13px;
            }
            .time-option.sel {
                border-color: #b9efe7;
                background: var(--accent-ghost);
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <div class="brand">
                <div class="logo"></div>
                <h2>Medperfekt</h2>
            </div>

            <!-- WELCOME (скрыт, так как форма открывается сразу) -->
            <section id="scr-home" class="card" style="display: none;">
                <h1>Лечение в лучших клиниках Германии</h1>
                <p class="muted">
                    Организация диагностики, лечения и реабилитации — мы берём
                    заботы на себя.
                </p>
                <div class="row">
                    <button class="btn" id="ctaStart">Подать заявку</button>
                </div>
            </section>

            <!-- Плашка "готово" после отправки -->
            <section
                id="scr-done"
                class="card"
                style="display: none; text-align: center"
            >
                <div class="ok">✅</div>
                <h1>Заявка отправлена</h1>
                <p class="muted">Мы свяжемся с вами в ближайшее время.</p>
                <div class="row" style="justify-content: center">
                    <button class="btn outline" onclick="resetFlow()">
                        На главную
                    </button>
                </div>
            </section>
        </div>

        <div id="overlay" class="overlay"></div>

        <!-- УПРОЩЕННАЯ ФОРМА: все в одном окне -->
        <div id="sheet-form" class="sheet" role="dialog" aria-modal="true">
            <div class="title">Подать заявку</div>
            <div class="subtitle">Заполните форму для связи с нами</div>
            
            <div class="grid">
                <!-- Выбор услуги -->
                <div class="field">
                    <label>Какая услуга вас интересует?</label>
                    <div class="service-grid" id="service-options">
                        <div class="service-option sel" data-val="treatment">Лечение/диагностика/реабилитация</div>
                        <div class="service-option" data-val="medicines">Заказ медикаментов</div>
                        <div class="service-option" data-val="second_opinion">«Второе мнение» немецкого специалиста</div>
                        <div class="service-option" data-val="translation">Перевод документов</div>
                    </div>
                </div>

                <!-- Описание запроса -->
                <div class="field">
                    <label>Опишите ваш запрос</label>
                    <textarea
                        id="inp-request"
                        placeholder="Например: консультация онколога, второе мнение по результатам МРТ..."
                    ></textarea>
                    <div class="hint">Минимум 10 символов</div>
                </div>

                <!-- Способ связи -->
                <div class="field">
                    <label>Как удобнее связаться?</label>
                    <div class="method" id="method-opts">
                        <div class="opt sel" data-val="WhatsApp">
                            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                                <path
                                    fill="#25D366"
                                    d="M20.52 3.48A11.86 11.86 0 0 0 12.06 0C5.49 0 .16 5.33.16 11.9c0 2.09.55 4.14 1.59 5.94L0 24l6.33-1.66a11.86 11.86 0 0 0 5.73 1.46h.01c6.57 0 11.9-5.33 11.9-11.9 0-3.17-1.23-6.15-3.45-8.42zM12.07 21.4h-.01a9.5 9.5 0 0 1-4.84-1.33l-.35-.2-3.76.98.99-3.66-.23-.37a9.5 9.5 0 1 1 8.2 4.58zm5.51-7.14c-.3-.15-1.77-.87-2.04-.97-.27-.1-.46-.15-.66.15-.19.3-.76.97-.93 1.17-.17.2-.34.22-.64.07-.3-.15-1.27-.47-2.42-1.5-.9-.8-1.51-1.78-1.69-2.08-.18-.3-.02-.46.13-.61.13-.13.3-.34.44-.51.15-.17.2-.3.3-.5.1-.2.05-.37-.02-.52-.07-.15-.66-1.59-.91-2.18-.24-.58-.48-.5-.66-.51l-.56-.01c-.2 0-.52.07-.79.37-.27.3-1.04 1.02-1.04 2.48 0 1.46 1.07 2.88 1.22 3.08.15.2 2.1 3.2 5.1 4.49.71.31 1.26.5 1.69.63.71.22 1.36.19 1.87.11.57-.08 1.77-.72 2.02-1.41.25-.69.25-1.28.17-1.41-.07-.13-.27-.2-.56-.35z"
                                />
                            </svg>
                            <b>WhatsApp</b>
                        </div>
                        <div class="opt" data-val="Telegram">
                            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                                <path
                                    fill="#0088CC"
                                    d="M9.999 15.2 9.9 19c.4 0 .6-.2.9-.4l2.2-2 4.5 3.3c.8.5 1.4.2 1.6-.8l2.9-13.5c.3-1.2-.4-1.7-1.2-1.4L2.1 9.1C.9 9.6.9 10.3 1.9 10.6l4.7 1.5L18.6 5c.5-.3 1-.1.6.2L9.999 15.2z"
                                />
                            </svg>
                            <b>Telegram</b>
                        </div>
                    </div>
                </div>

                <!-- Контактные данные -->
                <div class="field">
                    <label>Телефон</label>
                    <input
                        id="inp-phone"
                        type="tel"
                        inputmode="tel"
                        placeholder="+491234567890"
                        pattern="^\+[1-9]\d{1,14}$"
                        required
                    />
                    <div class="hint">Международный формат с кодом страны</div>
                </div>

                <div class="field">
                    <label>Email (необязательно)</label>
                    <input
                        id="inp-email"
                        type="email"
                        placeholder="name@example.com"
                    />
                </div>

                <!-- Предпочтительное время связи -->
                <div class="field">
                    <label>Предпочтительное время для связи</label>
                    <div class="time-options" id="time-options">
                        <div class="time-option sel" data-val="morning">До обеда</div>
                        <div class="time-option" data-val="afternoon">После обеда</div>
                        <div class="time-option" data-val="evening">Вечером</div>
                    </div>
                </div>
            </div>

            <div class="sticky">
                <div class="cta">
                    <button
                        class="btn ghost"
                        onclick="closeSheet('sheet-form')"
                    >
                        Отмена
                    </button>
                    <button class="btn" onclick="submitApp()">
                        Подать заявку
                    </button>
                </div>
            </div>
        </div>

        <script>
            const tg = window.Telegram?.WebApp;
            tg?.ready();
            tg?.expand();
            const $ = (id) => document.getElementById(id);

            // состояние
            const state = {
                service: "treatment",
                request: "",
                method: "WhatsApp",
                phone: "",
                email: null,
                time: "morning",
            };

            // инициализация
            function initForm() {
                // Выбор услуги
                for (const el of $("service-options").querySelectorAll(".service-option")) {
                    el.onclick = () => {
                        for (const n of $("service-options").children)
                            n.classList.remove("sel");
                        el.classList.add("sel");
                        state.service = el.getAttribute("data-val");
                    };
                }

                // Выбор способа связи
                for (const el of $("method-opts").querySelectorAll(".opt")) {
                    el.onclick = () => {
                        for (const n of $("method-opts").children)
                            n.classList.remove("sel");
                        el.classList.add("sel");
                        state.method = el.getAttribute("data-val");
                    };
                }

                // Выбор времени
                for (const el of $("time-options").querySelectorAll(".time-option")) {
                    el.onclick = () => {
                        for (const n of $("time-options").children)
                            n.classList.remove("sel");
                        el.classList.add("sel");
                        state.time = el.getAttribute("data-val");
                    };
                }
            }

            // управление панелями
            function openSheet(id) {
                $("overlay").classList.add("show");
                $(id).classList.add("show");
            }
            function closeSheet(id) {
                $(id).classList.remove("show");
                $("overlay").classList.remove("show");
            }

            // открытие формы
            $("ctaStart").onclick = () => {
                initForm();
                openSheet("sheet-form");
            };

            // Автоматическое открытие формы при загрузке страницы
            document.addEventListener('DOMContentLoaded', function() {
                initForm();
                openSheet("sheet-form");
            });

            function resetFlow() {
                $("scr-done").style.display = "none";
                $("scr-home").style.display = "block";
            }

            function sanitizePhone(raw) {
                // пробелы, дефисы, точки, скобки, неразрывные пробелы — убрать
                let s = raw.replace(/[\u00A0\s\-\.\(\)]/g, "");
                // оставить только первую '+' и цифры
                s = s.replace(/(?!^)\+/g, "").replace(/[^\d+]/g, "");
                return s;
            }

            function submitApp() {
                // Валидация
                const request = $("inp-request").value.trim();
                if (request.length < 10) {
                    alert("Опишите запрос подробнее (минимум 10 символов).");
                    $("inp-request").focus();
                    return;
                }
                state.request = request;

                const phone = document.getElementById("inp-phone");
                phone.value = sanitizePhone(phone.value);
                if (!phone.checkValidity()) {
                    alert("Укажите телефон в международном формате (пример: +491234567890).");
                    phone.focus();
                    return;
                }
                state.phone = phone.value.trim();

                const email = $("inp-email").value.trim();
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email)) {
                    alert("Похоже, e-mail введён с ошибкой.");
                    return;
                }
                state.email = email || null;

                // Отправка данных
                const payload = {
                    service: state.service,
                    request: state.request,
                    method: state.method,
                    phone: state.phone,
                    email: state.email,
                    time: state.time,
                    ts: Date.now(),
                };

                if (tg) {
                    tg.sendData(JSON.stringify(payload));
                    alert("Заявка отправлена. Спасибо!");
                    tg.close();
                } else {
                    console.log("Demo payload:", payload);
                    alert("Откройте форму из Telegram для реальной отправки.");
                    $("scr-home").style.display = "none";
                    $("scr-done").style.display = "block";
                    closeSheet("sheet-form");
                }
            }

            function escapeHTML(s) {
                return String(s)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#39;");
            }
        </script>
    </body>
</html>