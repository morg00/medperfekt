<!doctype html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width,initial-scale=1,viewport-fit=cover"
        />
        <meta name="robots" content="noindex,nofollow" />
        <title>Medperfekt — Заявка</title>
        <script src="https://telegram.org/js/telegram-web-app.js"></script>
        <style>
            :root {
                --bg: #f6fbfc;
                --card: #fff;
                --ink: #0e2733;
                --muted: #6b7a86;
                --accent: #12c2b0;
                --accent-ghost: #e6faf7;
                --ring: #b8efe8;
                --radius: 18px;
                --shadow: 0 14px 40px rgba(10, 40, 50, 0.08);
            }
            * {
                box-sizing: border-box;
            }
            html,
            body {
                margin: 0;
            }
            body {
                min-height: 100dvh;
                background: var(--bg);
                color: var(--ink);
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Inter,
                    Roboto,
                    Arial;
            }
            .wrap {
                max-width: 760px;
                margin: 0 auto;
                padding: 20px 16px calc(20px + env(safe-area-inset-bottom));
            }
            .brand {
                display: flex;
                align-items: center;
                gap: 12px;
                margin: 2px 0 16px;
            }
            .logo {
                width: 44px;
                height: 44px;
                border-radius: 14px;
                background: #0bbfaa url("photo.jpg") center/cover no-repeat;
                box-shadow: 0 6px 18px rgba(11, 191, 170, 0.22);
            }
            .brand h2 {
                margin: 0;
                font-size: 18px;
                font-weight: 800;
                letter-spacing: 0.2px;
            }

            /* Стили для переключателя языка */
            .lang-switcher {
                margin-left: auto;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .lang-btn {
                border: 1px solid #e3edf0;
                border-radius: 8px;
                padding: 4px 8px;
                background: #fff;
                cursor: pointer;
                font-size: 12px;
            }
            .lang-btn.sel {
                border-color: var(--accent);
                background-color: var(--accent-ghost);
                color: var(--ink);
            }

            .card {
                background: var(--card);
                border-radius: 22px;
                box-shadow: var(--shadow);
                border: 1px solid #edf3f5;
                padding: 18px;
            }
            h1 {
                font-size: 22px;
                margin: 2px 0 10px;
            }
            .muted {
                color: var(--muted);
                font-size: 14px;
            }

            .grid {
                display: grid;
                gap: 14px;
            }
            .row {
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
            }
            .field {
                display: grid;
                gap: 8px;
            }
            label {
                font-size: 15px;
                color: var(--ink);
                font-weight: 700;
            }

            input,
            select,
            textarea {
                width: 100%;
                padding: 13px 14px;
                border: 1px solid #e3edf0;
                border-radius: 14px;
                background: #fff;
                font-size: 16px;
                line-height: 1.2;
                outline: none;
            }
            input:focus,
            textarea:focus,
            select:focus {
                border-color: var(--ring);
                box-shadow: 0 0 0 4px rgba(18, 194, 176, 0.12);
            }
            ::placeholder {
                color: #9aa8b2;
            }
            textarea {
                min-height: 110px;
                resize: vertical;
            }

            .btn {
                height: 54px;
                border-radius: 16px;
                border: 0;
                background: var(--accent);
                color: #fff;
                font-weight: 800;
                cursor: pointer;
                padding: 0 20px;
            }
            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
            .btn.ghost {
                background: var(--accent-ghost);
                color: #064e47;
                border: 1px solid #d2f4ee;
            }
            .btn.outline {
                background: #fff;
                border: 1px solid #e3edf0;
                color: var(--ink);
            }
            .cta {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            /* карточные опции */
            .method {
                display: flex;
                gap: 12px;
            }
            .method .opt {
                flex: 1;
                display: flex;
                align-items: center;
                gap: 10px;
                border: 1px solid #e3edf0;
                border-radius: 14px;
                padding: 12px;
                cursor: pointer;
                background: #fff;
                color: #5b6b76;
            }
            .method .opt b {
                color: #2b3b45;
            }
            .method .opt.sel {
                border-color: #b9efe7;
                background: var(--accent-ghost);
                color: #0e2733;
            }
            .method .icon {
                width: 28px;
                height: 28px;
                border-radius: 7px;
                display: block;
            }

            .service-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .service-option {
                padding: 16px 12px;
                border: 1px solid #e3edf0;
                border-radius: 14px;
                background: #fff;
                cursor: pointer;
                text-align: center;
                font-size: 14px;
                font-weight: 600;
                color: #5b6b76;
            }
            .service-option.sel {
                border-color: #b9efe7;
                background: var(--accent-ghost);
                color: #0e2733;
            }

            .time-options {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 10px;
            }
            .time-option {
                padding: 12px 10px;
                border: 1px solid #e3edf0;
                border-radius: 12px;
                background: #fff;
                cursor: pointer;
                text-align: center;
                font-size: 13px;
                color: #5b6b76;
            }
            .time-option.sel {
                border-color: #b9efe7;
                background: var(--accent-ghost);
                color: #0e2733;
            }

            .hint {
                font-size: 12px;
                color: #7a8b96;
            }

            /* липкая область действий без fixed (не конфликтует с клавиатурой) */
            .sticky {
                position: sticky;
                bottom: 0;
                margin-top: 10px;
                background: linear-gradient(
                    180deg,
                    rgba(246, 251, 252, 0),
                    var(--bg) 40%
                );
                padding-top: 8px;
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <div class="brand">
                <div class="logo"></div>
                <h2>Medperfekt</h2>
                <!-- Переключатель языка -->
                <div class="lang-switcher">
                    <span id="lang-switcher-label">Language:</span>
                    <!-- Текст будет обновлен updateUI -->
                    <button id="lang-ru" class="lang-btn" data-lang="ru">
                        RU
                    </button>
                    <!-- Текст будет обновлен updateUI -->
                    <button id="lang-en" class="lang-btn" data-lang="en">
                        EN
                    </button>
                    <!-- Текст будет обновлен updateUI -->
                </div>
                <!-- /Переключатель языка -->
            </div>

            <!-- форма статично, без выдвижения -->
            <section
                id="form"
                class="card"
                role="form"
                aria-label="Подать заявку"
            >
                <h1 style="margin-bottom: 6px">Подать заявку</h1>
                <p class="muted" style="margin-top: 0">
                    Заполните форму для связи с нами
                </p>

                <div class="grid">
                    <!-- Услуги -->
                    <div class="field">
                        <label>Какая услуга вас интересует?</label>
                        <div class="service-grid" id="service-options">
                            <div
                                class="service-option sel"
                                data-val="treatment"
                            >
                                Лечение/диагностика/реабилитация
                            </div>
                            <div class="service-option" data-val="medicines">
                                Заказ медикаментов
                            </div>
                            <div
                                class="service-option"
                                data-val="second_opinion"
                            >
                                «Второе мнение» немецкого специалиста
                            </div>
                            <div class="service-option" data-val="translation">
                                Перевод документов
                            </div>
                        </div>
                    </div>

                    <!-- Описание -->
                    <div class="field">
                        <label>Опишите ваш запрос</label>
                        <textarea
                            id="inp-request"
                            placeholder="Например: консультация онколога, второе мнение по результатам МРТ..."
                        ></textarea>
                        <div class="hint">Минимум 10 символов</div>
                    </div>

                    <!-- Способ связи -->
                    <div class="field">
                        <label>Как удобнее связаться?</label>
                        <div class="method" id="method-opts">
                            <div class="opt sel" data-val="WhatsApp">
                                <svg
                                    class="icon"
                                    viewBox="0 0 24 24"
                                    aria-hidden="true"
                                >
                                    <path
                                        fill="#25D366"
                                        d="M20.52 3.48A11.86 11.86 0 0 0 12.06 0C5.49 0 .16 5.33.16 11.9c0 2.09.55 4.14 1.59 5.94L0 24l6.33-1.66a11.86 11.86 0 0 0 5.73 1.46h.01c6.57 0 11.9-5.33 11.9-11.9 0-3.17-1.23-6.15-3.45-8.42zM12.07 21.4h-.01a9.5 9.5 0 0 1-4.84-1.33l-.35-.2-3.76.98.99-3.66-.23-.37a9.5 9.5 0 1 1 8.2 4.58zm5.51-7.14c-.3-.15-1.77-.87-2.04-.97-.27-.1-.46-.15-.66.15-.19.3-.76.97-.93 1.17-.17.2-.34.22-.64.07-.3-.15-1.27-.47-2.42-1.5-.9-.8-1.51-1.78-1.69-2.08-.18-.3-.02-.46.13-.61.13-.13.3-.34.44-.51.15-.17.2-.3.3-.5.1-.2.05-.37-.02-.52-.07-.15-.66-1.59-.91-2.18-.24-.58-.48-.5-.66-.51l-.56-.01c-.2 0-.52.07-.79.37-.27.3-1.04 1.02-1.04 2.48 0 1.46 1.07 2.88 1.22 3.08.15.2 2.1 3.2 5.1 4.49.71.31 1.26.5 1.69.63.71.22 1.36.19 1.87.11.57-.08 1.77-.72 2.02-1.41.25-.69.25-1.28.17-1.41-.07-.13-.27-.2-.56-.35z"
                                    />
                                </svg>
                                <b>WhatsApp</b>
                            </div>
                            <div class="opt" data-val="Telegram">
                                <svg
                                    class="icon"
                                    viewBox="0 0 24 24"
                                    aria-hidden="true"
                                >
                                    <path
                                        fill="#0088CC"
                                        d="M9.999 15.2 9.9 19c.4 0 .6-.2.9-.4l2.2-2 4.5 3.3c.8.5 1.4.2 1.6-.8l2.9-13.5c.3-1.2-.4-1.7-1.2-1.4L2.1 9.1C.9 9.6.9 10.3 1.9 10.6l4.7 1.5L18.6 5c.5-.3 1-.1.6.2L9.999 15.2z"
                                    />
                                </svg>
                                <b>Telegram</b>
                            </div>
                        </div>
                    </div>

                    <!-- Телефон -->
                    <div class="field">
                        <label>Телефон</label>
                        <input
                            id="inp-phone"
                            type="tel"
                            inputmode="tel"
                            placeholder="+1234567890"
                            pattern="^\\+[1-9]\\d{1,14}$"
                            required
                        />
                        <div class="hint">
                            Международный формат с кодом страны
                        </div>
                    </div>

                    <!-- Email -->
                    <div class="field">
                        <label>Email (необязательно)</label>
                        <input
                            id="inp-email"
                            type="email"
                            placeholder="name@example.com"
                        />
                    </div>

                    <!-- Время связи -->
                    <div class="field">
                        <label>Предпочтительное время для связи</label>
                        <div class="time-options" id="time-options">
                            <div class="time-option sel" data-val="morning">
                                До обеда
                            </div>
                            <div class="time-option" data-val="afternoon">
                                После обеда
                            </div>
                            <div class="time-option" data-val="evening">
                                Вечером
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sticky">
                    <div class="cta">
                        <button class="btn ghost" type="button" id="btn-cancel">
                            Отмена
                        </button>
                        <button class="btn" type="button" id="btn-submit">
                            Подать заявку
                        </button>
                    </div>
                </div>
            </section>

            <!-- экран "готово" для демо-режима -->
            <section
                id="scr-done"
                class="card"
                style="display: none; text-align: center"
            >
                <div style="font-size: 56px">✅</div>
                <h1>Заявка отправлена</h1>
                <p class="muted">Мы свяжемся с вами в ближайшее время.</p>
                <div class="row" style="justify-content: center">
                    <button class="btn outline" type="button" id="btn-home">
                        На главную
                    </button>
                </div>
            </section>
        </div>

        <script>
            const tg = window.Telegram?.WebApp;
            tg?.ready();

            const $ = (id) => document.getElementById(id);

            // --- ЯЗЫКОВЫЕ РЕСУРСЫ ---
            const STRINGS = {
                ru: {
                    title: "Подать заявку",
                    subtitle: "Заполните форму для связи с нами",
                    serviceLabel: "Какая услуга вас интересует?",
                    service1: "Лечение/диагностика/реабилитация",
                    service2: "Заказ медикаментов",
                    service3: "«Второе мнение» немецкого специалиста",
                    service4: "Перевод документов",
                    requestLabel: "Опишите ваш запрос",
                    requestPlaceholder:
                        "Например: консультация онколога, второе мнение по результатам МРТ...",
                    hintMinLength: "Минимум 10 символов",
                    methodLabel: "Как удобнее связаться?",
                    phoneLabel: "Телефон",
                    phonePlaceholder: "+1234567890",
                    phoneHint: "Международный формат с кодом страны",
                    emailLabel: "Email (необязательно)",
                    emailPlaceholder: "name@example.com",
                    timeLabel: "Предпочтительное время для связи",
                    time1: "До обеда",
                    time2: "После обеда",
                    time3: "Вечером",
                    btnCancel: "Отмена",
                    btnSubmit: "Подать заявку",
                    alertReqLength:
                        "Опишите запрос подробнее (минимум 10 символов).",
                    alertPhoneFormat:
                        "Укажите телефон в международном формате (пример: +491234567890).",
                    alertEmailFormat: "Похоже, e-mail введён с ошибкой.",
                    thankYouTitle: "Заявка отправлена",
                    thankYouText: "Мы свяжемся с вами в ближайшее время.",
                    btnHome: "На главную",
                    demoSend:
                        "Откройте форму из Telegram для реальной отправки.",
                    botThankYou:
                        "✅ Заявка отправлена. Спасибо! <b>Medperfekt</b>",
                    // Тексты для переключателя языка
                    langSwitcherLabel: "Язык:",
                    langRu: "RU",
                    langEn: "EN",
                },
                en: {
                    title: "Submit Request",
                    subtitle: "Fill out the form to contact us",
                    serviceLabel: "Which service are you interested in?",
                    service1: "Treatment/Diagnosis/Rehabilitation",
                    service2: "Order Medications",
                    service3: "Second Opinion from a German Specialist",
                    service4: "Document Translation",
                    requestLabel: "Describe your request",
                    requestPlaceholder:
                        "For example: oncologist consultation, second opinion on MRI results...",
                    hintMinLength: "Minimum 10 characters",
                    methodLabel: "How would you prefer to be contacted?",
                    phoneLabel: "Phone",
                    phonePlaceholder: "+1234567890",
                    phoneHint: "International format with country code",
                    emailLabel: "Email (optional)",
                    emailPlaceholder: "name@example.com",
                    timeLabel: "Preferred time for contact",
                    time1: "Before lunch",
                    time2: "After lunch",
                    time3: "In the evening",
                    btnCancel: "Cancel",
                    btnSubmit: "Submit Request",
                    alertReqLength:
                        "Please describe your request in more detail (minimum 10 characters).",
                    alertPhoneFormat:
                        "Please enter the phone number in international format (e.g., +491234567890).",
                    alertEmailFormat:
                        "The email address seems to be entered incorrectly.",
                    thankYouTitle: "Request Sent",
                    thankYouText: "We will contact you shortly.",
                    btnHome: "Home",
                    demoSend:
                        "Open the form from Telegram for actual submission.",
                    botThankYou:
                        "✅ Request sent. Thank you! <b>Medperfekt</b>",
                    // Тексты для переключателя языка
                    langSwitcherLabel: "Language:",
                    langRu: "RU",
                    langEn: "EN",
                },
            };
            // --- /ЯЗЫКОВЫЕ РЕСУРСЫ ---

            // --- ОПРЕДЕЛЕНИЕ ЯЗЫКА (Изменено: Telegram/Browser приоритет, дефолт - en) ---
            function detectLanguage() {
                // Попробовать получить язык из URL (высший приоритет)
                const urlParams = new URLSearchParams(location.search);
                const urlLang = urlParams.get("lang");
                if (urlLang && STRINGS[urlLang]) {
                    console.log("Using language from URL:", urlLang);
                    return urlLang;
                }

                // Попробовать получить язык из Telegram (второй приоритет)
                const tgLang = tg?.initDataUnsafe?.user?.language_code;
                if (tgLang && STRINGS[tgLang]) {
                    console.log("Using language from Telegram:", tgLang);
                    return tgLang;
                }
                if (tgLang) {
                    const shortCode = tgLang
                        .split("_")[0]
                        .split("-")[0]
                        .toLowerCase();
                    if (STRINGS[shortCode]) {
                        console.log(
                            "Using language from Telegram (short code):",
                            shortCode,
                        );
                        return shortCode;
                    }
                }

                // Попробовать получить язык из браузера (третий приоритет)
                const browserLang =
                    navigator.language || navigator.languages[0];
                if (browserLang) {
                    const shortCode = browserLang
                        .split("_")[0]
                        .split("-")[0]
                        .toLowerCase();
                    if (STRINGS[shortCode]) {
                        console.log("Using language from browser:", shortCode);
                        return shortCode;
                    }
                }

                // Дефолтный язык - английский
                console.log("Using default language: en");
                return "en";
            }

            // Функция для сохранения выбранного языка
            function saveLanguage(langCode) {
                if (STRINGS[langCode]) {
                    localStorage.setItem("mp_lang", langCode);
                    console.log("Saved language to localStorage:", langCode);
                }
            }
            // --- /ОПРЕДЕЛЕНИЕ ЯЗЫКА ---

            // --- ОБНОВЛЕНИЕ ИНТЕРФЕЙСА ---
            function updateUI(langCode) {
                const strings = STRINGS[langCode] || STRINGS["en"]; // fallback на английский, если язык не найден
                const $ = (id) => document.getElementById(id);

                // Обновить заголовки и тексты в секции формы
                const titleEl = document.querySelector("#form h1");
                if (titleEl) titleEl.textContent = strings.title;

                const subtitleEl = document.querySelector("#form p.muted");
                if (subtitleEl) subtitleEl.textContent = strings.subtitle;

                // Обновить метки полей
                const labels = document.querySelectorAll("label");
                labels.forEach((label) => {
                    if (
                        label.textContent.trim() ===
                            "Какая услуга вас интересует?" ||
                        label.textContent.trim() ===
                            "Which service are you interested in?"
                    ) {
                        label.textContent = strings.serviceLabel;
                    } else if (
                        label.textContent.trim() === "Опишите ваш запрос" ||
                        label.textContent.trim() === "Describe your request"
                    ) {
                        label.textContent = strings.requestLabel;
                    } else if (
                        label.textContent.trim() === "Как удобнее связаться?" ||
                        label.textContent.trim() ===
                            "How would you prefer to be contacted?"
                    ) {
                        label.textContent = strings.methodLabel;
                    } else if (
                        label.textContent.trim() === "Телефон" ||
                        label.textContent.trim() === "Phone"
                    ) {
                        label.textContent = strings.phoneLabel;
                    } else if (
                        label.textContent.trim() === "Email (необязательно)" ||
                        label.textContent.trim() === "Email (optional)"
                    ) {
                        label.textContent = strings.emailLabel;
                    } else if (
                        label.textContent.trim() ===
                            "Предпочтительное время для связи" ||
                        label.textContent.trim() ===
                            "Preferred time for contact"
                    ) {
                        label.textContent = strings.timeLabel;
                    }
                });

                // Обновить тексты внутри карточных опций (услуги)
                const serviceOptions = document.querySelectorAll(
                    "#service-options .service-option",
                );
                serviceOptions.forEach((opt) => {
                    if (
                        opt.textContent.trim() ===
                            "Лечение/диагностика/реабилитация" ||
                        opt.textContent.trim() ===
                            "Treatment/Diagnosis/Rehabilitation"
                    ) {
                        opt.textContent = strings.service1;
                    } else if (
                        opt.textContent.trim() === "Заказ медикаментов" ||
                        opt.textContent.trim() === "Order Medications"
                    ) {
                        opt.textContent = strings.service2;
                    } else if (
                        opt.textContent.trim() ===
                            "«Второе мнение» немецкого специалиста" ||
                        opt.textContent.trim() ===
                            "Second Opinion from a German Specialist"
                    ) {
                        opt.textContent = strings.service3;
                    } else if (
                        opt.textContent.trim() === "Перевод документов" ||
                        opt.textContent.trim() === "Document Translation"
                    ) {
                        opt.textContent = strings.service4;
                    }
                });

                // Обновить placeholder текста
                const requestTextarea = $("inp-request");
                if (requestTextarea)
                    requestTextarea.placeholder = strings.requestPlaceholder;

                // Обновить подсказку длины
                const hintMinLength = document.querySelector(".hint"); // Предполагается, что первая .hint - это для запроса
                if (hintMinLength)
                    hintMinLength.textContent = strings.hintMinLength;

                // Обновить placeholder и hint телефона
                const phoneInput = $("inp-phone");
                if (phoneInput) {
                    phoneInput.placeholder = strings.phonePlaceholder;
                    const phoneHint = phoneInput.nextElementSibling; // Подсказка сразу после инпута
                    if (phoneHint && phoneHint.classList.contains("hint")) {
                        phoneHint.textContent = strings.phoneHint;
                    }
                }

                // Обновить placeholder email
                const emailInput = $("inp-email");
                if (emailInput)
                    emailInput.placeholder = strings.emailPlaceholder;

                // Обновить тексты времени связи
                const timeOptions = document.querySelectorAll(
                    "#time-options .time-option",
                );
                timeOptions[0].textContent = strings.time1;
                timeOptions[1].textContent = strings.time2;
                timeOptions[2].textContent = strings.time3;

                // Обновить тексты кнопок
                const btnCancel = $("btn-cancel");
                if (btnCancel) btnCancel.textContent = strings.btnCancel;

                const btnSubmit = $("btn-submit");
                if (btnSubmit) btnSubmit.textContent = strings.btnSubmit;

                // Обновить экран "готово"
                const doneTitle = document.querySelector("#scr-done h1");
                if (doneTitle) doneTitle.textContent = strings.thankYouTitle;

                const doneText = document.querySelector("#scr-done p.muted");
                if (doneText) doneText.textContent = strings.thankYouText;

                const btnHome = $("btn-home");
                if (btnHome) btnHome.textContent = strings.btnHome;

                // Обновить переключатель языка (если он есть)
                const langSwitcherLabel = document.getElementById(
                    "lang-switcher-label",
                );
                if (langSwitcherLabel)
                    langSwitcherLabel.textContent = strings.langSwitcherLabel;
                const langRuBtn = document.getElementById("lang-ru");
                if (langRuBtn) langRuBtn.textContent = strings.langRu;
                const langEnBtn = document.getElementById("lang-en");
                if (langEnBtn) langEnBtn.textContent = strings.langEn;

                // Обновить активный класс кнопок переключателя
                const langButtons = document.querySelectorAll(".lang-btn");
                langButtons.forEach((btn) => {
                    if (btn.getAttribute("data-lang") === langCode) {
                        btn.classList.add("sel"); // Добавляем класс 'sel' для выбранного языка
                    } else {
                        btn.classList.remove("sel"); // Убираем класс 'sel' с других
                    }
                });
            }
            // --- /ОБНОВЛЕНИЕ ИНТЕРФЕЙСА ---

            // --- ПЕРЕКЛЮЧЕНИЕ ЯЗЫКА (Изменено: всегда обновляет код страны) ---
            function switchLanguage(langCode) {
                if (STRINGS[langCode]) {
                    state.language = langCode; // Обновляем язык в состоянии
                    saveLanguage(langCode); // Сохраняем выбор в localStorage
                    updateUI(langCode); // Обновляем интерфейс
                    console.log("Language switched via button to:", langCode);

                    // Обновляем код страны телефона при переключении языка, даже если поле не пустое
                    const phoneInput = $("inp-phone");
                    if (phoneInput) {
                        const currentNumber = phoneInput.value.replace(
                            /^\+\d{1,4}\s*/,
                            "",
                        ); // Сохраняем введённый номер без кода
                        const newCode = guessCountryCodeImproved(); // Получаем новый код на основе state.language
                        phoneInput.value = newCode + " " + currentNumber; // Подставляем новый код и старый номер
                        try {
                            phoneInput.setSelectionRange(
                                phoneInput.value.length,
                                phoneInput.value.length,
                            );
                        } catch {} // Курсор в конец
                    }
                }
            }
            // --- /ПЕРЕКЛЮЧЕНИЕ ЯЗЫКА ---

            // Состояние (добавлено поле language)
            const state = {
                service: "treatment",
                request: "",
                method: "WhatsApp",
                phone: "",
                email: null,
                time: "morning",
                language: "" /* Будет установлено ниже */,
            };

            // Выборы (без изменений)
            function bindSelectable(containerId, itemClass, key) {
                const box = $(containerId);
                for (const el of box.querySelectorAll("." + itemClass)) {
                    el.onclick = () => {
                        for (const n of box.children) n.classList.remove("sel");
                        el.classList.add("sel");
                        state[key] = el.getAttribute("data-val");
                    };
                }
            }

            // --- Улучшенное автоопределение кода страны (Изменено: учитывает state.language, дефолт - en) ---
            // (Весь ваш текущий код для определения кода страны остается как есть)
            const CC_BY_REGION = {
                RU: "+7",
                KZ: "+7",
                US: "+1",
                CA: "+1",
                CZ: "+420",
                SK: "+421",
                DE: "+49",
                TR: "+90",
                UA: "+380",
                PL: "+48",
                FR: "+33",
                ES: "+34",
                IT: "+39",
                GB: "+44",
                AE: "+971",
                CN: "+86",
                JP: "+81",
            };
            const CC_BY_TZ_PREFIX = {
                "Europe/Prague": "+420",
                "Europe/Bratislava": "+421",
                "Europe/Berlin": "+49",
                "Europe/Moscow": "+7",
                "Asia/Almaty": "+7",
                "America/": "+1", // любой TZ в Америке
            };

            function urlCountryCode() {
                const m = new URLSearchParams(location.search).get("cc");
                return m && /^\+\d{1,4}$/.test(m) ? m : null;
            }
            function savedCountryCode() {
                const v = localStorage.getItem("mp_cc");
                return v && /^\+\d{1,4}$/.test(v) ? v : null;
            }
            function saveCountryCode(cc) {
                if (/^\+\d{1,4}$/.test(cc)) localStorage.setItem("mp_cc", cc);
            }

            function languageRegion() {
                const langs = [
                    tg?.initDataUnsafe?.user?.language_code,
                    navigator.language,
                    ...(navigator.languages || []),
                ].filter(Boolean);
                for (const l of langs) {
                    try {
                        // Пытаемся достать регион из локали
                        const loc = new Intl.Locale(l);
                        if (loc.region && CC_BY_REGION[loc.region])
                            return loc.region;
                    } catch (_) {
                        // Fallback: парсим суффикс -RU/-CZ/...
                        const m = String(l).match(/-([A-Z]{2})$/i);
                        if (m) return m[1].toUpperCase();
                    }
                }
                return null;
            }

            function tzToCode() {
                const tz =
                    Intl.DateTimeFormat().resolvedOptions().timeZone || "";
                for (const key of Object.keys(CC_BY_TZ_PREFIX)) {
                    if (key.endsWith("/") ? tz.startsWith(key) : tz === key) {
                        return CC_BY_TZ_PREFIX[key];
                    }
                }
                return null;
            }

            function guessCountryCodeImproved() {
                // 1) Принудительно из URL или сохранённого выбора
                const forced = urlCountryCode() || savedCountryCode();
                if (forced) return forced;

                // 2) Язык интерфейса index.html (RU/EN)
                const uiLang = (state.language || "")
                    .split("_")[0]
                    .split("-")[0]
                    .toLowerCase();
                if (uiLang === "en") return "+1";
                if (uiLang === "ru") return "+7";

                // 3) Регион из языка (Telegram/Browser)
                const region = languageRegion();
                if (region && CC_BY_REGION[region]) {
                    console.log(
                        "Using code based on region:",
                        region,
                        CC_BY_REGION[region],
                    );
                    return CC_BY_REGION[region];
                }

                // 4) Таймзона
                const byTz = tzToCode();
                if (byTz) {
                    console.log("Using code based on timezone:", byTz);
                    return byTz;
                }

                // 5) Слабые эвристики (Telegram/Browser language)
                const lang = (
                    tg?.initDataUnsafe?.user?.language_code ||
                    navigator.language ||
                    "en"
                ).toLowerCase();
                if (lang.startsWith("ru") || lang.startsWith("kk")) {
                    console.log(
                        "Using +7 based on Telegram/Browser language (ru/kk)",
                    );
                    return "+7";
                }
                if (lang.startsWith("cs")) return "+420";
                if (lang.startsWith("de")) return "+49";
                if (lang.startsWith("tr")) return "+90";
                if (lang.startsWith("uk") || lang.startsWith("ua"))
                    return "+380";
                if (lang.startsWith("en")) {
                    console.log(
                        "Using +1 based on Telegram/Browser language (en)",
                    );
                    return "+1";
                }

                // 6) Дефолт
                console.log("Using default code +420");
                return "+420";
            }

            function prefillPhoneImproved() {
                const el = $("inp-phone");
                if (!el) return;

                // Только когда пусто — подставляем
                if (!el.value.trim()) {
                    const cc = guessCountryCodeImproved(); // <-- Теперь учитывает state.language
                    el.value = cc + " ";
                    try {
                        el.setSelectionRange(el.value.length, el.value.length);
                    } catch {}

                    // Если пользователь руками поменял код — запомним
                    const remember = () => {
                        const m = el.value.trim().match(/^\+\d{1,4}/);
                        if (m) saveCountryCode(m[0]);
                    };
                    el.addEventListener("change", remember);
                    el.addEventListener("blur", remember);
                }
            }
            // -----------------------------------------------

            // Прокрутка инпутов к центру при фокусе (без изменений)
            function ensureVisibleOnFocus(sel) {
                for (const el of document.querySelectorAll(sel)) {
                    el.addEventListener("focus", () => {
                        el.scrollIntoView({
                            behavior: "smooth",
                            block: "center",
                            inline: "nearest",
                        });
                    });
                }
            }

            // Санитайзер телефона (без изменений)
            function sanitizePhone(raw) {
                let s = raw.replace(/[\u00A0\s\-\.\(\)]/g, ""); // пробелы/дефисы/скобки
                s = s.replace(/(?!^)\+/g, "").replace(/[^\d+]/g, ""); // оставить + и цифры
                return s;
            }

            // Валидация + отправка (изменено: добавлено поле language в payload)
            function submitApp() {
                const req = $("inp-request").value.trim();
                if (req.length < 10) {
                    alert(
                        STRINGS[state.language]?.alertReqLength ||
                            STRINGS["en"].alertReqLength,
                    ); // Используем строку на текущем языке, fallback на en
                    $("inp-request").focus();
                    return;
                }
                state.request = req;

                const phoneEl = $("inp-phone");
                phoneEl.value = sanitizePhone(phoneEl.value);
                if (!phoneEl.checkValidity()) {
                    alert(
                        STRINGS[state.language]?.alertPhoneFormat ||
                            STRINGS["en"].alertReqLength,
                    ); // Используем строку на текущем языке, fallback на en
                    phoneEl.focus();
                    return;
                }
                state.phone = phoneEl.value.trim();

                const email = $("inp-email").value.trim();
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email)) {
                    alert(
                        STRINGS[state.language]?.alertEmailFormat ||
                            STRINGS["en"].alertReqLength,
                    ); // Используем строку на текущем языке, fallback на en
                    $("inp-email").focus();
                    return;
                }
                state.email = email || null;

                const payload = {
                    service: state.service,
                    request: state.request,
                    method: state.method,
                    phone: state.phone,
                    email: state.email,
                    time: state.time,
                    language: state.language, // <-- Добавляем язык в payload (язык интерфейса на момент отправки)
                    ts: Date.now(),
                };

                if (tg) {
                    tg.sendData(JSON.stringify(payload));
                    // alert('Заявка отправлена. Спасибо!'); // Заменяем на сообщение на языке пользователя
                    alert(
                        STRINGS[state.language]?.botThankYou ||
                            STRINGS["en"].botThankYou,
                    ); // fallback на en
                    tg.close();
                } else {
                    console.log("Demo payload:", payload);
                    // alert('Откройте форму из Telegram для реальной отправки.'); // Заменяем на сообщение на языке пользователя
                    alert(
                        STRINGS[state.language]?.demoSend ||
                            STRINGS["en"].demoSend,
                    ); // fallback на en
                    document.getElementById("form").style.display = "none";
                    document.getElementById("scr-done").style.display = "block";
                    // Также обновляем текст на экране "готово" на случай демонстрации
                    document.querySelector("#scr-done h1").textContent =
                        STRINGS[state.language]?.thankYouTitle ||
                        STRINGS["en"].thankYouTitle; // fallback на en
                    document.querySelector("#scr-done p.muted").textContent =
                        STRINGS[state.language]?.thankYouText ||
                        STRINGS["en"].thankYouText; // fallback на en
                }
            }

            function closeApp() {
                if (tg) {
                    tg.close();
                } else {
                    document.getElementById("form").style.display = "none";
                    document.getElementById("scr-done").style.display = "block";
                }
            }

            // Инициализация (изменено: определяем язык и обновляем UI)
            (function init() {
                // 1. Определяем язык (Telegram/Browser приоритет над localStorage, fallback на en)
                state.language = detectLanguage(); // Сохраняем определенный язык в state

                // 2. Обновляем интерфейс на основе определенного языка
                updateUI(state.language);

                // 3. Привязываем выборы (без изменений)
                bindSelectable("service-options", "service-option", "service");
                bindSelectable("method-opts", "opt", "method");
                bindSelectable("time-options", "time-option", "time");

                // 4. Привязываем кнопки (без изменений)
                $("btn-submit").onclick = submitApp;
                $("btn-cancel").onclick = closeApp;
                $("btn-home").onclick = () => {
                    location.reload();
                };

                // 5. Добавляем обработчики для переключателя языка
                document.getElementById("lang-ru").onclick = () =>
                    switchLanguage("ru");
                document.getElementById("lang-en").onclick = () =>
                    switchLanguage("en");

                // 6. Другие инициализации (без изменений)
                ensureVisibleOnFocus("input, textarea, select");
                prefillPhoneImproved(); // <— НОВАЯ версия, учитывает state.language

                console.log(
                    "Initialization complete. Current language (from Telegram/Browser/storage/detect):",
                    state.language,
                );
            })();
        </script>
    </body>
</html>
